<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title> Digital Electronics Attendance </title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 500px; margin: auto; }
    h2 { margin-bottom: 10px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
    button { background: #2e7d32; color: white; border: none; cursor: pointer; }
    button:disabled { background: #888; cursor: not-allowed; }
    #status { margin-top: 10px; font-size: 0.95rem; }
    .error { color: red; font-size: 0.85rem; }
  </style>
</head>
<body>

  <h2> Digital Electronics Lab Attendance</h2>
  <p>Please fill your details and allow location access.</p>

  <label>Your Name</label>
  <input type="text" id="name" placeholder="First and last name" oninput="validateName()">
  <div id="nameError" class="error"></div>

  <label>Student ID</label>
  <input type="text" id="id" placeholder="Matrikelnummer or ID" oninput="validateID()">
  <div id="idError" class="error"></div>

  <button id="btn" onclick="getLocation()">Submit Attendance</button>

  <p id="status"></p>

<script>
  const LAB_LAT = 52.47658458055089;
  const LAB_LON = 13.45780966572938;
  const ALLOWED_RADIUS = 80;

  // ---------- VALIDATION ----------
  function validateName() {
    const name = document.getElementById("name").value;
    const regex = /^[A-Za-z ]+$/;

    if (!regex.test(name)) {
      document.getElementById("nameError").innerText = "Name must contain only alphabets.";
      return false;
    }
    document.getElementById("nameError").innerText = "";
    return true;
  }

  function validateID() {
    const id = document.getElementById("id").value;
    const regex = /^[0-9]+$/;

    if (!regex.test(id)) {
      document.getElementById("idError").innerText = "Matrikelnummer must contain only numbers.";
      return false;
    }
    document.getElementById("idError").innerText = "";
    return true;
  }

  // Haversine distance formula
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lat2 - lon1);
    const a =
      Math.sin(dLat/2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function setStatus(msg) {
    document.getElementById("status").innerText = msg;
  }

  function getLocation() {
    const nameValid = validateName();
    const idValid = validateID();

    if (!nameValid || !idValid) {
      setStatus("Please correct the errors before submitting.");
      return;
    }

    const name = document.getElementById("name").value.trim();
    const id = document.getElementById("id").value.trim();

    if (!navigator.geolocation) {
      setStatus("Geolocation is not supported on this device.");
      return;
    }

    document.getElementById("btn").disabled = true;
    setStatus("Requesting location, please wait...");

    navigator.geolocation.getCurrentPosition(success, error, {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    });
  }

function success(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;
  const distance = getDistance(lat, lon, LAB_LAT, LAB_LON);

  if (distance <= ALLOWED_RADIUS) {
    setStatus("Inside lab area (" + distance.toFixed(1) + " m). Marking your attendance as PRESENT...  Thank you!");
    sendToServer(lat, lon, distance);
  } else {
    setStatus("Attendance denied. You are outside the lab radius (" +
              distance.toFixed(1) + " m). Marking your attendance as ABSENT.");
    sendToServer(lat, lon, distance);   // <--- NEW: Still send to server
  }
}


  function error(err) {
    setStatus("Could not get location: " + err.message);
    document.getElementById("btn").disabled = false;
  }

function sendToServer(lat, lon, distance) {
  const name = encodeURIComponent(document.getElementById("name").value.trim());
  const id = encodeURIComponent(document.getElementById("id").value.trim());

  const url =
    "https://script.google.com/macros/s/AKfycbyoal6Xu2S1ON90wbKSZVmzvsrlSlzh_lMGvX6lKAmRmYbCF7Qsoi3HXgO5UQ-uybu3/exec" +
    "?key=" + encodeURIComponent("P@sswd1234") +
    "&name=" + name +
    "&id=" + id +
    "&lat=" + lat +
    "&lon=" + lon +
    "&distance=" + distance;

  fetch(url)
    .then(r => r.text())
    .then(t => {
      // KEEP ORIGINAL MESSAGE â€” DO NOT OVERWRITE
      document.getElementById("btn").disabled = false;
    })
    .catch(e => {
      setStatus("Error sending data: " + e);
      document.getElementById("btn").disabled = false;
    });
}

</script>

</body>
</html>





