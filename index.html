<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mechatronics Lab Attendance</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 500px; margin: auto; }
    h2 { margin-bottom: 10px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
    button { background: #2e7d32; color: white; border: none; cursor: pointer; }
    button:disabled { background: #888; cursor: not-allowed; }
    #status { margin-top: 10px; font-size: 0.95rem; }
  </style>
</head>

<body>

<h2>Mechatronics Lab Attendance</h2>
<p>Please fill your details and allow location access.</p>

<label>Your Name</label>
<input type="text" id="name" placeholder="First and last name">

<label>Student ID</label>
<input type="text" id="id" placeholder="Matrikelnummer or ID">

<button id="btn" onclick="getLocation()">Submit Attendance</button>

<p id="status"></p>

<script>
  // Lab location
  const LAB_LAT = 52.476383;
  const LAB_LON = 13.457703;

  // 80-meter allowed zone
  const ALLOWED_RADIUS = 80;

  // Haversine formula
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function setStatus(msg) {
    document.getElementById("status").innerText = msg;
  }

  function getLocation() {
    const name = document.getElementById("name").value.trim();
    const id = document.getElementById("id").value.trim();

    if (!name || !id) {
      setStatus("Please enter both name and student ID.");
      return;
    }

    document.getElementById("btn").disabled = true;
    setStatus("Requesting GPS location...");

    navigator.geolocation.getCurrentPosition(success, error, {
      enableHighAccuracy: true,
      timeout: 20000,
      maximumAge: 0
    });
  }

  function success(pos) {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const accuracy = pos.coords.accuracy || 0;
    const speed = pos.coords.speed || 0;

    const distance = getDistance(lat, lon, LAB_LAT, LAB_LON);

    setStatus("Location received. Sending data...");

    sendToServer(lat, lon, distance, accuracy, speed);
  }

  function error(err) {
    setStatus("Location error: " + err.message);
    document.getElementById("btn").disabled = false;
  }

  function sendToServer(lat, lon, distance, accuracy, speed) {
    const name = encodeURIComponent(document.getElementById("name").value.trim());
    const id = encodeURIComponent(document.getElementById("id").value.trim());

    const url =
      "https://script.google.com/macros/s/AKfycbz9qsbOfaKfdeV9n5KvuFiYtPYzMrdzBu_m5Nw-mpfuRbDynptcyF5x_TVs47dRJB3s/exec" +
      "?key=" + encodeURIComponent("P@sswd1234") +
      "&name=" + name +
      "&id=" + id +
      "&lat=" + lat +
      "&lon=" + lon +
      "&distance=" + distance +
      "&accuracy=" + accuracy +
      "&speed=" + speed;

    fetch(url)
      .then(r => r.text())
      .then(t => {
        setStatus(t);
        document.getElementById("btn").disabled = false;
      })
      .catch(e => {
        setStatus("Error sending data: " + e);
        document.getElementById("btn").disabled = false;
      });
  }
</script>

</body>
</html>
